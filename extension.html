<!DOCTYPE html>
<html>
<head>
  <title>Data Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: darkblue;
      color: white;
      padding-top: 20px;
    }
    #app {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      width: 100%;
      max-width: 800px;
      height: 100%;
    }
    #chat-container {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      background-color: #001f3f;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .chat-message {
      background-color: #fff;
      color: #000;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
      max-width: 70%;
      word-wrap: break-word;
    }
    .chat-message.user {
      align-self: flex-end;
      background-color: #007bff;
      color: #fff;
    }
    .chat-message.bot {
      align-self: flex-start;
    }
    #search-container {
      display: flex;
      align-items: center;
      position: relative;
      width: 100%;
      max-width: 600px;
      margin: 0 auto;
      margin-bottom: 10px;
    }
    #prompt {
      width: 100%;
      padding: 10px 40px 10px 10px;
      font-size: 16px;
      font-family: Arial, sans-serif;
      border: 2px solid #ccc;
      border-radius: 20px;
      outline: none;
      box-sizing: border-box;
      resize: none;
      overflow: hidden;
    }
    #search-button {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0;
    }
    #search-icon {
      width: 20px;
      height: 20px;
    }
    #suggestion-box {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 600px;
      margin: 10px auto;
    }
    .suggestion-button {
      background-color: rgba(255, 255, 255);
      border: 2px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #000;
      width: 48%;
      text-align: center;
      transition: background-color 0.3s, color 0.3s, transform 0.3s;
      margin: 10px;
    }
    .suggestion-button:hover {
      background-color: #ddd;
      color: #000;
      transform: scale(1.05);
    }
    #chartContainer {
      display: none;
      margin-top: 20px;
      width: 100%;
      height: 600px;
    }
    #cardContainer {
      display: none;
      margin: 20px auto 0 auto;
      width: 100%;
      max-width: 300px;
      background-color: #fff;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      color: #000;
      text-align: center;
    }
    .cardTitle {
      font-size: 14px;
      margin-bottom: 5px;
      color: #666;
    }
    .cardContent {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
      color: #000;
    }
    #aiResponseContainer {
      display: none;
      margin-top: 20px;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #fff;
      color: #000;
    }
    canvas {
      width: 100% !important;
      height: auto !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="chat-container"></div> <!-- New container for chat messages -->
    <div id="chartContainer">
      <canvas id="myChart"></canvas>
    </div>
    <div id="cardContainer"></div>
    <div id="search-container">
      <textarea id="prompt" placeholder="Search..."></textarea>
      <button id="search-button" onclick="sendPrompt()">
        <img src="data:image/png;base64,=" id="search-icon" alt="Search">
      </button>
    </div>
    <div id="suggestion-box"></div>
  </div>
  
  <script>
    // Your existing scripts

    const prompts = [
      'Plot a line chart to show the annual revenue growth from 2021 to 2023.',
      'Create a line graph to illustrate the monthly net income for each month in 2023.',
      'Generate a line graph showing the monthly revenue trend for the year 2023.',
      'Create a line graph to show the monthly net income for the year 2023.',
      'Produce a bar graph comparing annual revenue and expenses from 2021 to 2023.',
      'Generate a line graph showing the revenue trends for each month in 2023.',
      'Produce a bar graph showing operating costs for the four quarters of 2023.',
      'Create a bar graph showing the quarterly performance ratings of Alice in 2023.',
      'Generate a bar graph showing the monthly feedback scores for Product B in 2023.',
      'Generate a pie chart showing the distribution of annual revenue across different years.',
      'Create a pie chart that shows the distribution of monthly expenses by department for the year 2023.',
      'Produce a pie chart showing the average customer feedback scores by product.',
      'Create a pie chart to show the distribution of monthly revenue across different months in 2023.',
      'Produce a pie chart displaying the distribution of average performance ratings across different employees.',
      'What was the total revenue for the year 2023?',
      'What was the feedback score for Product A in March 2023?',
      'How much did the Marketing department spend in April 2023?',
      'What was Alice\'s performance rating by the end of the second quarter of 2023?',
      'What was the net income in June 2023?',
      'What was the profit by the end of the third quarter of 2023?',
      'Generate a multi line chart for monthly Sales for Product C and Product D for 2023',
      'Create a multi line chart for customer Feedback Scores for Product A, Product B, Product C, and Product D for 2023',
      'Produce a multi line chart about the department Expenses for Marketing, R&D, HR, and Finance for 2023',
      'Create a multi line chart about the Employee Performance Ratings for Alice, Bob, Charlie, and Dana for 2023',
      'Produce a multi line chart to illustrate the monthly expenses for the Marketing and R&D departments in 2023'
    ];

    function getRandomPrompt() {
    return prompts[Math.floor(Math.random() * prompts.length)];
  }

  function displayRandomPrompts() {
    const suggestionBox = document.getElementById('suggestion-box');
    suggestionBox.innerHTML = '';

    for (let i = 0; i < 2; i++) { // Display two random prompts
      const randomPrompt = getRandomPrompt();
      const suggestionButton = document.createElement('div');
      suggestionButton.className = 'suggestion-button';
      suggestionButton.textContent = randomPrompt;
      suggestionButton.onclick = function() { setPrompt(randomPrompt); };
      suggestionBox.appendChild(suggestionButton);
    }
  }

  async function sendPrompt() {
    const promptValue = document.getElementById('prompt').value;
    console.log('Prompt entered:', promptValue);

    addChatMessage(promptValue, 'user');

    let chartType = null;
    if ((promptValue.toLowerCase().includes('multi line')) || (promptValue.toLowerCase().includes('multi-line'))) {
      chartType = 'complex'; // Custom type for complex multiple lines chart
    } else if (promptValue.toLowerCase().includes('line')) {
      chartType = 'line';
    } else if (promptValue.toLowerCase().includes('bar')) {
      chartType = 'bar';
    } else if (promptValue.toLowerCase().includes('pie')) {
      chartType = 'pie';
    }

    try {
      const response = await fetch('http://localhost:5000/fetch_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: promptValue })
      });

      console.log('Response status:', response.status);

      if (response.ok) {
        const result = await response.json();
        console.log('Data received:', result);
        const tableName = result.tableName || 'Chart';

        if (chartType === 'complex') {
          document.getElementById('cardContainer').style.display = 'none';
          document.getElementById('aiResponseContainer').style.display = 'none';
          determineComplexChartConfigAndDisplay(result.labels, result.datasets, tableName);
        } else if (chartType) {
          document.getElementById('cardContainer').style.display = 'none';
          document.getElementById('aiResponseContainer').style.display = 'none';
          determineChartConfigAndDisplay(result.data, chartType, tableName);
        } else if (result.response) {
          document.getElementById('chartContainer').style.display = 'none';
          document.getElementById('cardContainer').style.display = 'none';
          displayAIResponse(result.response);
        } else {
          document.getElementById('chartContainer').style.display = 'none';
          displayCard(result.data, tableName);
        }

        // Update random prompts after sending the prompt
        displayRandomPrompts();

      } else {
        console.error('Failed to fetch data:', response.statusText);
      }
    } catch (error) {
      console.error('Error occurred during fetch:', error);
    }
  }

  function addChatMessage(message, type) {
    const chatContainer = document.getElementById('chat-container');
    const chatMessage = document.createElement('div');
    chatMessage.className = `chat-message ${type}`;
    chatMessage.textContent = message;
    chatContainer.appendChild(chatMessage);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function displayAIResponse(response) {
    addChatMessage(response, 'bot');
  }

  displayRandomPrompts();
  </script>
  <script>
    const prompt = document.getElementById('prompt');

    function resizeTextarea() {
      prompt.style.height = 'auto';
      prompt.style.height = prompt.scrollHeight + 'px';
    }

    function setPrompt(text) {
      document.getElementById('prompt').value = text;
      resizeTextarea();
      sendPrompt();
    }

    prompt.addEventListener('input', function() {
      resizeTextarea();
    });
  </script>
  <script>
    function displayCard(data, tableName) {
      const cardContainer = document.getElementById('cardContainer');
      cardContainer.style.display = 'block';
      
      const cardTitle = tableName.charAt(0).toUpperCase() + tableName.slice(1).replace(/_/g, ' ');
      const firstItem = data[0];
      const valueKey = Object.keys(firstItem).find(key => typeof firstItem[key] === 'number');
      const value = firstItem[valueKey];

      cardContainer.innerHTML = `
        <div class="cardTitle">${cardTitle}</div>
        <div class="cardContent">$${value.toLocaleString()}</div>
      `;
    }

    function determineChartConfigAndDisplay(data, chartType, tableName) {
      if (!data || data.length === 0) {
        console.error('No data received to display');
        return;
      }
      console.log('Data for chart configuration:', data);
      let labels = [];
      let values = [];
      let xAxisLabel = '';
      let yAxisLabel = '';
      const firstItem = data[0];
      const dateProperties = ['month', 'year', 'quarter'];
      const numericProperties = Object.keys(firstItem).filter(key => typeof firstItem[key] === 'number');
      const dateProperty = dateProperties.find(prop => prop in firstItem);
      if (dateProperty) {
        if (dateProperty === 'month') {
          labels = data.map(item => {
            const date = luxon.DateTime.fromHTTP(item[dateProperty], { zone: 'utc' });
            console.log(`Parsing date '${item[dateProperty]}' as month:`, date);
            return date.isValid ? date.toFormat('yyyy-MM') : 'Invalid DateTime';
          });
        } else if (dateProperty === 'year') {
          labels = data.map(item => {
            const date = luxon.DateTime.fromHTTP(item[dateProperty], { zone: 'utc' });
            console.log(`Parsing date '${item[dateProperty]}' as year:`, date);
            return date.isValid ? date.toFormat('yyyy') : 'Invalid DateTime';
          });
        } else if(dateProperty === 'quarter') {
          labels = data.map(item => {
            const date = luxon.DateTime.fromHTTP(item[dateProperty], { zone: 'utc' });
            console.log(`Parsing date '${item[dateProperty]}' as quarter:`, date);
            return date.isValid ? `Q${Math.ceil(date.month / 3)} ${date.year}` : 'Invalid DateTime';
          });
        } else {
          labels = data.map(item => item[dateProperty]);
        }
        xAxisLabel = dateProperty.charAt(0).toUpperCase() + dateProperty.slice(1).replace(/_/g, ' ');
      } else if (chartType === 'pie') {
        // For pie charts, use non-date properties for labels if date property is not found
        const labelProperty = Object.keys(firstItem).find(key => typeof firstItem[key] === 'string');
        if (labelProperty) {
          labels = data.map(item => item[labelProperty]);
          xAxisLabel = labelProperty.charAt(0).toUpperCase() + labelProperty.slice(1).replace(/_/g, ' ');
        } else {
          console.error('No suitable property found for labels in pie chart');
          return;
        }
      } else {
        console.error('No date property found');
        return;
      }
      if (numericProperties.length > 0) {
        values = data.map(item => item[numericProperties[0]]);
        yAxisLabel = numericProperties[0].charAt(0).toUpperCase() + numericProperties[0].slice(1).replace(/_/g, ' ');
      } else {
        console.error('No numeric property found');
        return;
      }
      const chartTitle = tableName.charAt(0).toUpperCase() + tableName.slice(1).replace(/_/g, ' ');
      console.log('Labels:', labels);
      console.log('Values:', values);
      console.log('X Axis Label:', xAxisLabel);
      console.log('Y Axis Label:', yAxisLabel);
      console.log('Chart type:', chartType);
      console.log('Chart title:', chartTitle);
      displayChart(labels, values, xAxisLabel, yAxisLabel, chartType, chartTitle);
    }

    function determineComplexChartConfigAndDisplay(labels, datasets, tableName) {
      if (!datasets || datasets.length === 0) {
        console.error('No data received to display');
        return;
      }
      console.log('Labels:', labels);
      console.log('Datasets:', datasets);

      const formattedDatasets = datasets.map((dataset, index) => ({
        label: dataset.label,
        data: dataset.data,
        borderColor: generateColors().borderColors[index % generateColors().borderColors.length],
        backgroundColor: generateColors().colors[index % generateColors().colors.length].replace('0.9', '0.3'), // Adjust transparency here
        fill: false
      }));

      const chartTitle = tableName.charAt(0).toUpperCase() + tableName.slice(1).replace(/_/g, ' ');

      displayComplexChart(labels, formattedDatasets, 'Month', 'Values', chartTitle);
    }

    function displayComplexChart(labels, datasets, xAxisLabel, yAxisLabel, chartTitle) {
      const ctx = document.getElementById('myChart').getContext('2d');

      document.getElementById('chartContainer').style.display = 'block';

      if (window.myChart && typeof window.myChart.destroy === 'function') {
        window.myChart.destroy();
      }

      const chartOptions = {
        plugins: {
          title: {
            display: true,
            text: chartTitle,
            color: 'white'
          },
          legend: {
            labels: {
              color: 'white'
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false
          },
          hover: {
            mode: 'nearest',
            intersect: true
          }
        },
        scales: {
          x: {
            type: 'time',
            title: {
              display: true,
              text: xAxisLabel,
              color: 'white'
            },
            time: {
              unit: 'month',
              tooltipFormat: 'yyyy-MM'
            },
            adapters: {
              date: {
                lib: 'luxon'
              }
            },
            ticks: {
              color: 'white'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: yAxisLabel,
              color: 'white'
            },
            ticks: {
              color: 'white'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)'
            }
          }
        }
      };

      window.myChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: chartOptions
      });

      console.log('Complex chart rendered successfully');
    }

    function displayChart(labels, values, xAxisLabel, yAxisLabel, chartType, chartTitle) {
      const ctx = document.getElementById('myChart').getContext('2d');
      
      document.getElementById('chartContainer').style.display = 'block';

      if (window.myChart && typeof window.myChart.destroy === 'function') {
        window.myChart.destroy();
      }

      if (chartType === 'pie') {
        ctx.canvas.width = 75;  // Set the width for the pie chart
        ctx.canvas.height = 75; // Set the height for the pie chart
      }

      const chartOptions = {
        plugins: {
          title: {
            display: true,
            text: chartTitle,
            color: 'white'
          },
          legend: {
            labels: {
              color: 'white'
            }
          }
        }
      };

      if (chartType !== 'pie') {
        chartOptions.scales = {
          x: {
            type: chartType === 'bar' ? 'category' : 'time',
            title: {
              display: true,
              text: xAxisLabel,
              color: 'white'
            },
            time: {
              unit: chartType === 'bar' ? undefined : 'month',
              tooltipFormat: chartType === 'bar' ? undefined : 'yyyy-MM'
            },
            adapters: {
              date: {
                lib: 'luxon'
              }
            },
            ticks: {
              color: 'white'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: yAxisLabel,
              color: 'white'
            },
            ticks: {
              color: 'white'
            },
            grid: {
              color: 'rgba(255, 255, 255, 0.2)'
            }
          }
        };
      }

      const datasetConfig = {
        label: yAxisLabel,
        data: values,
        backgroundColor: chartType === 'pie' ? generateColors().colors : 'rgba(75, 192, 192, 0.2)',
        borderColor: chartType === 'pie' ? generateColors().borderColors : 'rgba(75, 192, 192, 1)',
        borderWidth: chartType === 'pie' ? 2 : 1,
        fill: chartType !== 'bar' && chartType !== 'pie'
      };

      window.myChart = new Chart(ctx, {
        type: chartType,
        data: {
          labels: labels,
          datasets: [datasetConfig]
        },
        options: chartOptions
      });

      console.log('Chart rendered successfully');
    }


    function generateColors() {
      const colors = [
        'rgba(128, 190, 175, 0.9)', 
        'rgba(179, 221, 209, 0.9)', 
        'rgba(209, 220, 226, 0.9)', 
        'rgba(245, 185, 148, 0.9)', 
        'rgba(238, 156, 108, 0.9)', 
        'rgba(245, 240, 176, 0.9)'
      ];
      const borderColors = [
        '#689c8f', '#9fc4ba', '#afc0c9', '#e0a27b', '#d9814e', '#e8e297'
      ];
      return {colors, borderColors};
    }
  </script>
</body>
</html>
